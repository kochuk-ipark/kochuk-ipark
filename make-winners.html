<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>winners.json 생성기</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#fff;color:#111;line-height:1.6}
    .wrap{max-width:900px;margin:0 auto;padding:18px}
    .card{border:1px solid #e9e9e9;border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);background:#fff}
    textarea{width:100%;min-height:220px;border:1px solid #e9e9e9;border-radius:12px;padding:12px;font-size:14px}
    .muted{color:#666;font-size:13px;margin:6px 0 0}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{padding:12px 14px;border-radius:12px;border:1px solid rgba(0,0,0,.12);background:rgba(0,0,0,.06);font-weight:800;cursor:pointer}
    button:hover{background:rgba(0,0,0,.10)}
    pre{white-space:pre-wrap;word-break:break-word;background:#fafafa;border:1px solid #eee;border-radius:12px;padding:12px;margin-top:12px}
    .ok{color:#0a7a3b;font-weight:800}
    .bad{color:#b42318;font-weight:800}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .small{font-size:12px;color:#777}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>winners.json 생성기</h1>
    <p class="muted">
      엑셀/구글시트에서 <b>이름 / 생년월일6자리 / 타입</b> 3열을 복사해서 아래에 붙여넣으면,
      결과조회용 <b>winners.json</b>을 만들어줍니다.
    </p>

    <div class="grid">
      <div class="card">
        <h2 style="margin:0 0 8px;font-size:18px">1) 명단 붙여넣기</h2>
        <textarea id="input" placeholder="예)
홍길동    930204    RD_64
김철수    001231    MD_74"></textarea>
        <p class="muted">
          - 엑셀에서 3열(이름/생년월일6자리/타입) 선택 → 복사 → 여기 붙여넣기<br>
          - 구분자는 탭/쉼표/공백 모두 어느 정도 자동 처리됩니다.
        </p>

        <div class="btnrow">
          <button id="btnMake">winners.json 만들기</button>
          <button id="btnDownload" disabled>다운로드</button>
          <button id="btnClear">초기화</button>
        </div>
        <p class="small">※ 원문(이름/생년월일)은 파일에 저장하지 않고, 해시(key)만 json에 들어갑니다.</p>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px;font-size:18px">2) 결과</h2>
        <div id="status" class="muted">아직 생성되지 않았습니다.</div>
        <pre id="output">{}</pre>
        <div class="muted">
          GitHub 저장소 루트에 <b>winners.json</b>으로 업로드하면 results.html 조회가 됩니다.
        </div>
      </div>
    </div>
  </div>

<script>
  function normalizeName(v){
    return (v || "").trim().replace(/\s+/g,""); // 공백 제거(조회 페이지와 동일)
  }
  function normalizeBirth6(v){
    return (v || "").trim().replace(/\D/g,"").slice(0,6); // 숫자만 6자리
  }
  function normalizeType(v){
    return (v || "").trim();
  }

  async function sha256Hex(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b => b.toString(16).padStart(2,"0")).join("");
  }

  function parseLines(raw){
    const lines = raw.split(/\r?\n/).map(x => x.trim()).filter(Boolean);
    const rows = [];
    for(const line of lines){
      // 탭 우선 → 없으면 콤마 → 그래도 없으면 공백 여러개
      let parts = line.split("\t");
      if(parts.length < 3) parts = line.split(",");
      if(parts.length < 3) parts = line.split(/\s{2,}/); // 공백 2개 이상
      if(parts.length < 3) parts = line.split(/\s+/); // 마지막 수단: 공백
      rows.push(parts.map(p => String(p).trim()));
    }
    return rows;
  }

  let lastJsonText = "";

  document.getElementById("btnClear").addEventListener("click", () => {
    document.getElementById("input").value = "";
    document.getElementById("output").textContent = "{}";
    document.getElementById("status").textContent = "초기화 완료";
    document.getElementById("btnDownload").disabled = true;
    lastJsonText = "";
  });

  document.getElementById("btnMake").addEventListener("click", async () => {
    const raw = document.getElementById("input").value;
    const rows = parseLines(raw);

    const winners = [];
    const errors = [];
    const seen = new Set();

    for(let i=0;i<rows.length;i++){
      const r = rows[i];
      const name = normalizeName(r[0] || "");
      const birth6 = normalizeBirth6(r[1] || "");
      const type = normalizeType(r[2] || "");

      if(!name) { errors.push(`${i+1}행: 이름 없음`); continue; }
      if(!/^\d{6}$/.test(birth6)) { errors.push(`${i+1}행: 생년월일6자리 오류 (${r[1]||""})`); continue; }
      if(!type) { errors.push(`${i+1}행: 타입 없음`); continue; }

      const key = await sha256Hex(birth6 + "|" + name); // results.html과 동일 규칙
      const dupKey = key + "|" + type;
      if(seen.has(dupKey)) continue;
      seen.add(dupKey);

      winners.push({ key, type });
    }

    const obj = { winners };
    lastJsonText = JSON.stringify(obj, null, 2);
    document.getElementById("output").textContent = lastJsonText;

    const status = document.getElementById("status");
    if(errors.length){
      status.innerHTML = `<span class="bad">⚠ 일부 행에 오류가 있습니다.</span><br>${errors.slice(0,12).join("<br>")}${errors.length>12? "<br>...(생략)":""
      }<br><br><span class="ok">정상 생성된 항목: ${winners.length}명</span>`;
    }else{
      status.innerHTML = `<span class="ok">✅ 생성 완료: ${winners.length}명</span>`;
    }

    document.getElementById("btnDownload").disabled = !winners.length;
  });

  document.getElementById("btnDownload").addEventListener("click", () => {
    if(!lastJsonText) return;
    const blob = new Blob([lastJsonText], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "winners.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });
</script>
</body>
</html>
